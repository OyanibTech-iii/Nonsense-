{{ form_start(form, {'attr': {'class': 'space-y-6'}}) }}
    <div class="card">
        {# <div class="card-header bg-gradient-to-r from-bright-green to-dark-forest-green">
            <h3 class="text-sm font-semibold text-white flex items-center gap-2">
                <ion-icon name="cube-outline" class="text-sm"></ion-icon>
                Stock Information
            </h3>
        </div> #}
        <div class="card-body space-y-6">
            <!-- Products Selection (Full Width) -->
            <div class="form-group">
                {{ form_label(form.products, null, {'label_attr': {'class': 'form-label'}}) }}
                <div class="relative products-dropdown-wrapper">
                    {{ form_widget(form.products, {'attr': {
                        'class': 'hidden products-select',
                        'size': '1',
                        'aria-hidden': 'true',
                        'tabindex': '-1'
                    }}) }}
                </div>
                {{ form_errors(form.products) }}
                <p class="text-sm text-gray-500 mt-1">Select a product to associate with this stock entry</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Current Quantity -->
                <div class="form-group">
                    {{ form_label(form.Quantity, null, {'label_attr': {'class': 'form-label'}}) }}
                    <div class="relative">
                        {{ form_widget(form.Quantity, {'attr': {
                            'class': 'form-input pl-10',
                            'placeholder': 'Enter current stock quantity'
                        }}) }}
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <ion-icon name="cube-outline" class="text-gray-400"></ion-icon>
                        </div>
                    </div>
                    {{ form_errors(form.Quantity) }}
                </div>

                <!-- Stock Type -->
                <div class="form-group">
                    {{ form_label(form.stockType, null, {'label_attr': {'class': 'form-label'}}) }}
                    <div class="relative">
                        {{ form_widget(form.stockType, {'attr': {
                            'class': 'form-input pl-10'
                        }}) }}
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <ion-icon name="pricetag-outline" class="text-gray-400"></ion-icon>
                        </div>
                    </div>
                    {{ form_errors(form.stockType) }}
                </div>

                <!-- Minimum Quantity -->
                <div class="form-group">
                    {{ form_label(form.minimumQuantity, null, {'label_attr': {'class': 'form-label'}}) }}
                    <div class="relative">
                        {{ form_widget(form.minimumQuantity, {'attr': {
                            'class': 'form-input pl-10',
                            'placeholder': 'Enter minimum stock level'
                        }}) }}
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <ion-icon name="trending-down-outline" class="text-gray-400"></ion-icon>
                        </div>
                    </div>
                    {{ form_errors(form.minimumQuantity) }}
                </div>

                <!-- Maximum Quantity -->
                <div class="form-group">
                    {{ form_label(form.maximumQuantity, null, {'label_attr': {'class': 'form-label'}}) }}
                    <div class="relative">
                        {{ form_widget(form.maximumQuantity, {'attr': {
                            'class': 'form-input pl-10',
                            'placeholder': 'Enter maximum stock level'
                        }}) }}
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <ion-icon name="trending-up-outline" class="text-gray-400"></ion-icon>
                        </div>
                    </div>
                    {{ form_errors(form.maximumQuantity) }}
                </div>
            </div>

            <!-- Storage Location (Full Width) -->
            <div class="form-group">
                {{ form_label(form.location, null, {'label_attr': {'class': 'form-label'}}) }}
                <div class="relative">
                    {{ form_widget(form.location, {'attr': {
                        'class': 'form-input pl-10',
                        'placeholder': 'Enter storage location (e.g., Warehouse A, Shelf 3)'
                    }}) }}
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <ion-icon name="location-outline" class="text-gray-400"></ion-icon>
                    </div>
                </div>
                {{ form_errors(form.location) }}
            </div>
        </div>
    </div>

    <div class="flex items-center justify-between pt-6">
        {% if app.request.get('_route') starts with 'app_admin_' %}
            <a href="{{ path('app_admin_stocks') }}" 
               class="btn-secondary flex items-center gap-2">
                <ion-icon name="arrow-back-outline"></ion-icon>
                Back to List
            </a>
        {% else %}
            <a href="{{ path('app_stock_index') }}" 
               class="btn-secondary flex items-center gap-2">
                <ion-icon name="arrow-back-outline"></ion-icon>
                Back to List
            </a>
        {% endif %}
        <button type="submit" class="btn-primary flex items-center gap-2 px-4 py-2 text-sm">
            <ion-icon name="checkmark-outline" class="text-sm"></ion-icon>
            {{ button_label|default('Save Stock') }}
        </button>
    </div>
{{ form_end(form) }}

<!-- Styling replaced with Tailwind utility classes; rely on Tailwind instead of custom CSS -->

<script>
document.addEventListener('DOMContentLoaded', function() {
    const select = document.querySelector('select.products-select');
    if (!select) return;
    
    const wrapper = select.closest('.products-dropdown-wrapper');
    if (!wrapper) return;
    
    // Create custom dropdown display (Tailwind classes) - matches form-input styling
    const display = document.createElement('div');
    display.className = 'products-dropdown-display w-full min-h-[42px] px-4 pl-10 border border-gray-300 rounded-md bg-white flex items-center text-sm text-gray-700 cursor-pointer hover:border-gray-400 focus-within:ring-2 focus-within:ring-bright-green focus-within:border-bright-green transition-all duration-200 relative';
    display.setAttribute('tabindex', '0');
    display.setAttribute('role', 'combobox');
    display.setAttribute('aria-expanded', 'false');
    display.setAttribute('aria-haspopup', 'listbox');

    // Icon on the left (matching other form inputs)
    const icon = document.createElement('div');
    icon.className = 'absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none';
    icon.innerHTML = '<ion-icon name="pricetags-outline" class="text-gray-400"></ion-icon>';
    display.appendChild(icon);

    // Content span keeps text separate from caret SVG so updates don't remove the caret
    const contentSpan = document.createElement('span');
    contentSpan.className = 'flex-1 truncate text-gray-500';
    contentSpan.textContent = 'Select a product';
    display.appendChild(contentSpan);

    // Caret SVG on the right (uses Tailwind sizing and color)
    const caret = document.createElement('span');
    caret.className = 'ml-2 flex items-center text-gray-400 transition-transform duration-200';
    caret.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
        </svg>`;
    display.appendChild(caret);
    
    // Create dropdown menu
    const menu = document.createElement('div');
    menu.className = 'products-dropdown-menu absolute top-full left-0 right-0 mt-1 bg-white border border-gray-200 rounded-md shadow-lg max-h-72 overflow-y-auto z-50 hidden';
    menu.setAttribute('role', 'listbox');
    menu.style.display = 'none';
    
    // Create options in menu
    const options = Array.from(select.options);
    options.forEach((option, index) => {
        // Skip empty/placeholder option
        if (!option.value) return;
        
        const optionDiv = document.createElement('div');
        optionDiv.className = 'products-dropdown-option px-3 py-2.5 cursor-pointer hover:bg-gray-50 transition-colors duration-150 text-sm text-gray-700';
        optionDiv.setAttribute('role', 'option');
        optionDiv.setAttribute('data-value', option.value);
        optionDiv.textContent = option.textContent;
        
        // Handle click on option - single selection
        optionDiv.addEventListener('click', function() {
            // Clear previous selection
            select.value = '';
            options.forEach(opt => opt.selected = false);
            
            // Set new selection
            option.selected = true;
            select.value = option.value;
            
            updateDisplay();
            toggleMenu(); // Close menu after selection
            select.dispatchEvent(new Event('change', { bubbles: true }));
        });
        
        if (option.selected) {
            optionDiv.classList.add('bg-primary-50', 'text-bright-green', 'font-medium');
        }
        
        menu.appendChild(optionDiv);
    });
    
    // Update display text
    function updateDisplay() {
        const selectedOption = select.options[select.selectedIndex];
        if (!selectedOption || !selectedOption.value) {
            contentSpan.textContent = 'Select a product';
            contentSpan.className = 'flex-1 truncate text-gray-500';
        } else {
            contentSpan.textContent = selectedOption.textContent;
            contentSpan.className = 'flex-1 truncate text-gray-700';
        }

        // Update selected styles in menu
        menu.querySelectorAll('.products-dropdown-option').forEach((optionDiv) => {
            const value = optionDiv.getAttribute('data-value');
            if (select.value === value) {
                optionDiv.classList.add('bg-primary-50', 'text-bright-green', 'font-medium');
            } else {
                optionDiv.classList.remove('bg-primary-50', 'text-bright-green', 'font-medium');
            }
        });
    }
    
    // Toggle menu
    function toggleMenu() {
        const isOpen = menu.style.display !== 'none' && menu.style.display !== '';
        if (isOpen) {
            menu.style.display = 'none';
            menu.classList.add('hidden');
            display.setAttribute('aria-expanded', 'false');
            caret.style.transform = 'rotate(0deg)';
            display.classList.remove('ring-2', 'ring-bright-green', 'border-bright-green');
        } else {
            menu.style.display = 'block';
            menu.classList.remove('hidden');
            display.setAttribute('aria-expanded', 'true');
            caret.style.transform = 'rotate(180deg)';
            display.classList.add('ring-2', 'ring-bright-green', 'border-bright-green');
        }
    }
    
    // Event listeners
    display.addEventListener('click', toggleMenu);
    display.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            toggleMenu();
        }
    });
    
    // Close menu when clicking outside
    document.addEventListener('click', function(e) {
        if (!wrapper.contains(e.target)) {
            menu.style.display = 'none';
            menu.classList.add('hidden');
            display.setAttribute('aria-expanded', 'false');
            caret.style.transform = 'rotate(0deg)';
            display.classList.remove('ring-2', 'ring-bright-green', 'border-bright-green');
        }
    });
    
    // Handle Escape key to close menu
    display.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            menu.style.display = 'none';
            menu.classList.add('hidden');
            display.setAttribute('aria-expanded', 'false');
            caret.style.transform = 'rotate(0deg)';
            display.classList.remove('ring-2', 'ring-bright-green', 'border-bright-green');
        }
    });
    
    // Initialize display
    updateDisplay();
    
    // Set wrapper to relative positioning if not already
    wrapper.style.position = 'relative';
    
    // Insert elements
    wrapper.appendChild(display);
    wrapper.appendChild(menu);
    
    // Initialize menu as hidden
    menu.style.display = 'none';
});
</script>
